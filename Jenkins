pipeline {
    agent any

    environment {
        NODEJS_HOME = tool 'nodejs-23'           // Node.js installation in Jenkins
        PATH = "${NODEJS_HOME}/bin:${env.PATH}"
        IMAGE_NAME = "signup"                    // Docker image name
        CONTAINER_NAME = "signup"                // Docker container name
        DOCKER_PASSWORD = "040705"               // Docker password
    }

    stages {
        // üõ†Ô∏è Checkout the repository (only `Devops` folder)
        stage('Checkout') {
            steps {
                script {
                    // Clone only the Devops folder using sparse-checkout
                    sh """
                    rm -rf Devops_Training  # Remove existing folder if exists
                    git clone --filter=blob:none --no-checkout https://github.com/VIBUDESH07/Devops_Training.git
                    cd Devops_Training
                    git sparse-checkout init --cone
                    git sparse-checkout set Devops
                    git checkout
                    """
                }
            }
        }

        // üì¶ Install dependencies
        stage('Install Dependencies') {
            steps {
                dir('Devops_Training/Devops') {  // Navigate into the cloned folder
                    sh 'npm install'
                }
            }
        }

        // üî® Build the React app
        stage('Build') {
            steps {
                dir('Devops_Training/Devops') {
                    sh 'npm run build'
                }
            }
        }

        // üê≥ Build Docker Image
        stage('Build Docker Image') {
            steps {
                script {
                    sh """
                    cd Devops_Training/Devops
                    echo '${DOCKER_PASSWORD}' | sudo -S docker build -t ${IMAGE_NAME} .
                    """
                }
            }
        }

        // üî• Stop and Remove Existing Container (if running)
        stage('Recreate or Create Container') {
            steps {
                script {
                    sh """
                    if sudo docker ps -a -q -f name=${CONTAINER_NAME}; then
                        echo "üî¥ Container ${CONTAINER_NAME} exists. Recreating..."
                        # Stop and remove the existing container
                        echo '${DOCKER_PASSWORD}' | sudo -S docker stop ${CONTAINER_NAME} || true
                        echo '${DOCKER_PASSWORD}' | sudo -S docker rm -f ${CONTAINER_NAME} || true
                    else
                        echo "üü¢ Container ${CONTAINER_NAME} does not exist. Creating a new one..."
                    fi

                    # Clean up dangling containers
                    echo "üßπ Cleaning up dangling containers..."
                    echo '${DOCKER_PASSWORD}' | sudo -S docker container prune -f
                    """
                }
            }
        }

        // üöÄ Run the Docker Container
        stage('Run Docker Container') {
            steps {
                script {
                    sh """
                    echo "üöÄ Starting container ${CONTAINER_NAME}..."
                    echo '${DOCKER_PASSWORD}' | sudo -S docker run -d -p 5000:80 --name ${CONTAINER_NAME} ${IMAGE_NAME}
                    """
                }
            }
        }

        // ‚úÖ Verify the Container is Running
        stage('Verify Container Running') {
            steps {
                script {
                    sh """
                    if sudo docker ps | grep -q ${CONTAINER_NAME}; then
                        echo "‚úÖ Container ${CONTAINER_NAME} is running successfully."
                    else
                        echo "‚ùå Failed to start container."
                        exit 1
                    fi
                    """
                }
            }
        }
    }
}
